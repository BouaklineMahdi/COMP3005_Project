{% extends "base.html" %}
{% block content %}
<h1>Login â€“ {{ role|title }}</h1>
<p class="muted">
    Use one of the seeded accounts from init_db.<br>
    Password is usually <code>password123</code>.
</p>

<div class="card" style="max-width: 420px;">
    <h2>{{ role|title }} Login</h2>
    <div id="msg"></div>
    <form id="loginForm">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required>

        <label for="password">Password</label>
        <input id="password" name="password" type="password" required>

        <button class="primary" type="submit">Login</button>
    </form>

    {% if role == "member" %}
    <hr>
    <div style="margin-top: 0.5rem; text-align: center;">
        <a href="/ui/register/member"
           style="
             display: inline-block;
             padding: 0.5rem 1rem;
             border-radius: 4px;
             background-color: #007bff;
             color: white;
             text-decoration: none;
             font-size: 0.9rem;
           ">
            New here? Register as a member
        </a>
    </div>
    {% endif %}
</div>

<script>
    (function() {
        const role = "{{ role }}";  // 'admin', 'trainer', or 'member'
        const form = document.getElementById("loginForm");
        const msgDiv = document.getElementById("msg");

        function setMessage(text, cls) {
            msgDiv.innerHTML = "";
            if (!text) return;
            const p = document.createElement("p");
            p.textContent = text;
            p.className = cls;
            msgDiv.appendChild(p);
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            setMessage("", "");

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const endpoint = `/auth/${role}-login`;
                const res = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email, password })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    setMessage("Login failed: " + errText, "error");
                    return;
                }

                const data = await res.json();
                // Expect LoginResponse: { role, user_id, email?, ... }
                localStorage.setItem("fc_role", data.role || role);
                localStorage.setItem("fc_user_id", data.user_id);
                localStorage.setItem("fc_email", data.email || email);

                setMessage("Login successful!", "success");

                let redirectPath = "/ui/dashboard/" + role;
                window.location.href = redirectPath;
            } catch (err) {
                console.error(err);
                setMessage("Unexpected error during login.", "error");
            }
        });
    })();
</script>
{% endblock %}
